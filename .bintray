#!/bin/sh

set -e

version=$(git tag --points-at HEAD | sed -e 's/^v//')
bintray_curl="curl -sf -unextdns:$API_KEY"
package=./dist/nextdns_${version}_linux
deb_repourl="https://api.bintray.com/content/nextdns/deb/nextdns/${version}"
rpm_repourl="https://api.bintray.com/content/nextdns/rpm/nextdns/${version}"

for arch in i386 amd64 armle armhf armv7 arm64 mips mips64 mips64le; do
    # Deb
    echo "Uploading ${package}_${arch}.deb"
    $bintray_curl -T ${package}_${arch}.deb "${deb_repourl}/pool/main/m/nextdns_${version}_${arch}.deb;deb_distribution=stable;deb_component=main;deb_architecture=${arch}"

    # RPM
    echo "Uploading ${package}_${arch}.rpm"
    $bintray_curl -T ${package}_${arch}.rpm "${rpm_repourl}/nextdns_${version}_${arch}.rpm"
done

echo "Signing and pubishing"
$bintray_curl -X POST https://api.bintray.com/calc_metadata/nextdns/deb/
$bintray_curl -X POST "$deb_repourl/publish"

echo "Signing and pubishing"
$bintray_curl -X POST https://api.bintray.com/calc_metadata/nextdns/rpm/
$bintray_curl -X POST "$rpm_repourl/publish"
